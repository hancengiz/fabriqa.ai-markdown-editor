name: Publish to VS Code Marketplace

on:
  # Auto-publish on push to master
  push:
    branches:
      - master

  # Allow manual trigger from GitHub UI
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Version bump type'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major

permissions:
  contents: write
  packages: write

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Install dependencies
        run: npm ci

      - name: Determine version bump type
        id: version-type
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "type=${{ inputs.version_type }}" >> $GITHUB_OUTPUT
          else
            # Auto-determine from commit messages
            COMMITS=$(git log $(git describe --tags --abbrev=0 2>/dev/null || echo "HEAD~10")..HEAD --pretty=format:"%s")

            if echo "$COMMITS" | grep -q "^BREAKING CHANGE:"; then
              echo "type=major" >> $GITHUB_OUTPUT
            elif echo "$COMMITS" | grep -q "^feat"; then
              echo "type=minor" >> $GITHUB_OUTPUT
            else
              echo "type=patch" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Get current version
        id: current-version
        run: echo "version=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT

      - name: Bump version
        id: new-version
        run: |
          npm version ${{ steps.version-type.outputs.type }} --no-git-tag-version
          NEW_VERSION=$(node -p "require('./package.json').version")
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Check if version changed
        id: version-changed
        run: |
          if [ "${{ steps.current-version.outputs.version }}" = "${{ steps.new-version.outputs.version }}" ]; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Run tests (if available)
        if: steps.version-changed.outputs.changed == 'true'
        run: npm test || echo "No tests configured"
        continue-on-error: true

      - name: Build extension
        if: steps.version-changed.outputs.changed == 'true'
        run: npm run build

      - name: Package extension
        if: steps.version-changed.outputs.changed == 'true'
        run: npx vsce package

      - name: Verify publisher and token
        if: steps.version-changed.outputs.changed == 'true'
        run: |
          echo "Checking publisher configuration..."
          PUBLISHER=$(node -p "require('./package.json').publisher")
          echo "Publisher ID: $PUBLISHER"

          if [ -z "${{ secrets.VSCE_PAT }}" ]; then
            echo "ERROR: VSCE_PAT secret is not set!"
            exit 1
          else
            echo "VSCE_PAT secret is configured (length: ${#VSCE_PAT})"
          fi

          # Try to show publisher info (will fail if publisher doesn't exist)
          npx vsce show "$PUBLISHER" || echo "Publisher '$PUBLISHER' may not exist yet on marketplace"
        env:
          VSCE_PAT: ${{ secrets.VSCE_PAT }}

      - name: Commit version bump
        if: steps.version-changed.outputs.changed == 'true'
        run: |
          git add package.json package-lock.json
          git commit -m "chore: bump version to v${{ steps.new-version.outputs.version }} [skip ci]"
          git tag -a "v${{ steps.new-version.outputs.version }}" -m "Release v${{ steps.new-version.outputs.version }}"
          git push origin master
          git push origin "v${{ steps.new-version.outputs.version }}"

      - name: Publish to VS Code Marketplace
        if: steps.version-changed.outputs.changed == 'true'
        run: npx vsce publish -p ${{ secrets.VSCE_PAT }}
        env:
          VSCE_PAT: ${{ secrets.VSCE_PAT }}

      - name: Create GitHub Release
        if: steps.version-changed.outputs.changed == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.new-version.outputs.version }}
          files: '*.vsix'
          body: |
            ## Release v${{ steps.new-version.outputs.version }}

            **Changes since v${{ steps.current-version.outputs.version }}**

            See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/master/CHANGELOG.md) for details.
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload VSIX artifact
        if: steps.version-changed.outputs.changed == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: vscode-extension-${{ steps.new-version.outputs.version }}
          path: '*.vsix'
          retention-days: 30
